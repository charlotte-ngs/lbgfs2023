---
title: "Generate Beef Cattle Data for BLUP"
output: html_notebook
---


## Background
The topic of BLUP is introduced using an example dataset from beef cattle. 


## Model
The data has weight at a certain age as response variable. The independent variables are herd and breast circumference. Furthermore, the breeding value of an animal is modeled using the known variance-covariance structure imposed by the given pedigree.


## Parameter
The parameter of the model consist of effects of herds, regression coefficients for breast circumference, and variance components.

```{r}
# herd effects
vec_herd <- c(23, 5, -11)
n_reg_bc <- 8.5
n_inter_bc <- -1050
n_mean_bc <- 170
n_sd_bc <- 2.1
n_var_phen <- 12
n_h2 <- 0.25
n_var_gen <- n_h2 * n_var_phen
n_var_res <- n_var_phen - n_var_gen
```



## Pedigree
The pedigree is given in tabular form by 

```{r}
n_nr_sire <- 3
n_nr_dam <- 8
n_nr_parents <- n_nr_sire + n_nr_dam
n_nr_offspring <- 12
n_nr_animals <- n_nr_parents + n_nr_offspring
### # assign parents to offspring and herds to records
vec_sire_id <- c(rep(1,6), rep(2,5), rep(9,4))
vec_dam_id <- c(3, 4, 5, rep(4:8,2), 10, 11)
tbl_bc_ped <- tibble::tibble(Animal = c(9, 10, 11, (n_nr_parents + 1):n_nr_animals),
                             Sire = vec_sire_id,
                             Dam  = vec_dam_id) 
tbl_bc_ped
```

From the above shown pedigree, we have to get to the numerator-relationship matrix $A$. We use the package `pedigreemm` to do that. First, we have to augment the pedigree by the founders. Founders are animals that do not occur in the column as animals, because, we do not know anything about their parents. The set of founder parents can be determined using the following set operations.

```{r}
vec_founder_sire <- setdiff(tbl_bc_ped$Sire, tbl_bc_ped$Animal)
vec_founder_dam <- setdiff(tbl_bc_ped$Dam, tbl_bc_ped$Animal)
vec_founder <- union(vec_founder_dam, vec_founder_sire)
(vec_founder <- vec_founder[order(vec_founder)])
```

In `pedigreemm` we can define a pedigree as follows

```{r}
n_nr_founder <- length(vec_founder)
pmm_bc_ped <- pedigreemm::pedigree(sire = c(rep(NA, n_nr_founder), tbl_bc_ped$Sire),
                                   dam = c(rep(NA, n_nr_founder), tbl_bc_ped$Dam),
                                   label = c(vec_founder, tbl_bc_ped$Animal))
pmm_bc_ped
```

From this pedigree, the numerator relationship matrix is computed as

```{r}
mat_A_bc <- pedigreemm::getA(ped = pmm_bc_ped)
dsy_mat_A_bc <- as(mat_A_bc, "dsyMatrix")
mat_A_bc
```

To generate the breeding values, we have to compute the cholesky decomposition of matrix $A$. This is

```{r}
mat_chol_A <- chol(mat_A_bc)
mat_chol_A
```

The breeding values are generated by first sampling a random vector from a normal distribution and the pre-multiplying it with the cholesky factor of $A$

```{r}
vec_u <- rnorm(n_nr_animals, mean = 0, sd = sqrt(n_var_gen))
mat_u <- crossprod(mat_chol_A, vec_u)
mat_u
```

## Fixed Effects and Regression
The fixed effects of the herds and the regression of breast circumference are generate.

```{r}
n_nr_records <- nrow(tbl_bc_ped)
vec_bc <- rnorm(n_nr_records, mean = n_mean_bc, sd = n_sd_bc)
vec_bc
```

Because the herds are fixed effects, we have to generate the herd effects via model matrix.

```{r}
vec_herd_codes <- c(rep(1,4), rep(2,3), rep(3,5), rep(2,3))
vec_y <- rnorm(length(vec_herd_codes))
mat_X_herd <- model.matrix(lm(y ~ 0 + herd, data = tibble::tibble(y = vec_y, herd = as.factor(vec_herd_codes))))
attr(mat_X_herd, "assign") <- NULL
attr(mat_X_herd, "contrasts") <- NULL
rownames(mat_X_herd) <- NULL
colnames(mat_X_herd) <- NULL
mat_herd_eff <- crossprod(t(mat_X_herd), vec_herd)
mat_herd_eff
```

The phenotypic data can be generated as

```{r}
mat_phen <- matrix(rep(n_inter_bc, n_nr_records), ncol=1) + 
  matrix(n_reg_bc * vec_bc, ncol=1) + 
  mat_herd_eff + 
  mat_u[(n_nr_founder+1):n_nr_animals,1] + 
  matrix(rnorm(n_nr_records, mean = 0, sd = sqrt(n_var_res)), ncol=1)
mat_phen
```

Collecting all data into a tibble

```{r}
tbl_bc_data <- tbl_bc_ped
tbl_bc_data$BreastCircumference <- round(vec_bc, digits = 0)
tbl_bc_data$Herd <- vec_herd_codes
tbl_bc_data$Weight <- round(mat_phen[,1], digits = 0)
tbl_bc_data
```

Write the data to a file

```{r}
s_bc_data <- here::here("docs", "data", "beef_data_blup.csv")
readr::write_delim(tbl_bc_data, s_bc_data)
```

